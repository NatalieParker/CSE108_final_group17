{% extends "base.html" %}
{% block title %}CSE 108 Final: {{ show.title }}{% endblock %}
{% block body %}

<div class="hero" style="margin-bottom: 2rem;"> 
  <img
    class="cover"
    src="{{ show.cover or url_for('static', filename='covers/default.jpg') }}"
    alt="{{ show.title }} cover"
  >
</div>

<div class="panel">

  <h1>{{ show.title }}</h1>

  <section class="panel">
    <h2>Community Rating</h2>
  
    {% if avg_rating %}
      <p><strong>Average:</strong> {{ avg_rating }} / 5</p>
  
      <ul>
        {% for star in range(5, 0, -1) %}
          <li>
            {{ star }}★ — {{ rating_map.get(star, 0) }} rating(s)
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No ratings yet.</p>
    {% endif %}
  </section>


  <section>
    <p><strong>Director:</strong> {{ show.director or "N/A" }}</p>
    <p><strong>Cast:</strong> {{ show.cast or "N/A" }}</p>
    <p><strong>Release Year:</strong> {{ show.release_year or "N/A" }}</p>
    <p><strong>Rating:</strong> {{ show.rating or "N/A" }}</p>
    <p><strong>Seasons:</strong> {{ show.seasons or "N/A" }}</p>
    <p><strong>Genres:</strong> {{ show.genres or "N/A" }}</p>
    <p><strong>Description:</strong></p>
    <p>{{ show.description or "No description available." }}</p>
  </section>
</div>

</div>

  <hr>

  <section class = "panel">
    <h2>Episodes</h2>

    {% if episodes %}
      <ul
        id="episodeList"
        data-show-id="{{ show.id }}"
        data-max-watched="{{ maxWatchedEpisode or 0 }}"
      >
        {% for ep in episodes %}
          <li
            class="episode-item"
            data-episode-id="{{ ep.id }}"
            data-episode-number="{{ ep.episode_number }}"
          >
          <label> 
            <input type="checkbox" class="episode-checkbox">
            Episode {{ ep.episode_number }}
          </label>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No episodes available.</p>
    {% endif %}
  </section>

  <hr>

<section class="panel reviews-section">

  <h2>Reviews</h2>

  {% if current_user.is_authenticated %}
  <div class="review-form-container">
    <h3>{% if userReview %}Edit Your Review{% else %}Write a Review{% endif %}</h3>
    <form id="reviewForm" method="POST" action="{{ url_for('add_review', show_id=show.id) }}">
      <label for="rating"><strong>Rating (1–5)</strong></label>
      <select id="rating" name="rating" required>
        {% for i in range(1, 6) %}
          <option value="{{ i }}" {% if userReview and userReview.rating == i %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>

      <label for="review_text"><strong>Review Text</strong></label>
      <textarea id="review_text" name="review_text" rows="5" required>{{ userReview.review_text if userReview }}</textarea>

      <button type="submit" class="btn btn-primary">
        {% if userReview %}Update Review{% else %}Submit Review{% endif %}
      </button>
    </form>
  </div>
  {% else %}
  <p><a href="{{ url_for('auth.login') }}">Sign in</a> to write a review.</p>
  {% endif %}

  <hr>
<section class="panel reviews-section">

  <h2>Reviews</h2>

  {% if reviews %}
    <div class="reviews-list">
      {% for review, username, rating, text in reviews %}
      <article class="review-card">
        <header>
          <strong class="review-username">{{ username }}</strong>
          <div class="review-rating" aria-label="Rating: {{ rating }} out of 5 stars">
            {% for i in range(1, 6) %}
              {% if i <= rating %}
                <span class="star filled">★</span>
              {% else %}
                <span class="star">☆</span>
              {% endif %}
            {% endfor %}
          </div>
        </header>
        <p class="review-text">{{ text }}</p>
      </article>
      {% endfor %}
    </div>
  {% else %}
    <p>No reviews yet.</p>
  {% endif %}

</section>


</section>

</section>

<section class="panel status-section" style="margin-top: 2rem;">
  <form method="POST" action="{{ url_for('set_status', show_id=show.id) }}">
    <label for="statusSelect"><strong>Watch Status</strong></label>
    <select id="statusSelect" name="status" class="status-select">
      <option value="planned" {% if current_status == "planned" %}selected{% endif %}>Plan to Watch</option>
      <option value="watching" {% if current_status == "watching" %}selected{% endif %}>Watching</option>
      <option value="completed" {% if current_status == "completed" %}selected{% endif %}>Completed</option>
    </select>
    <button type="submit" class="btn btn-primary status-btn">Save</button>
  </form>
</section>


<script src="{{ url_for('static', filename='show.js') }}"></script>

{% endblock %}
