{% extends "base.html" %}
{% block title %}CSE 108 Final: {{ show.title }}{% endblock %}
{% block body %}

<div class="hero"> 

    <img
      class="cover"
      src="{{ show.cover or url_for('static', filename='covers/default.jpg') }}"
      alt="{{ show.title }} cover"
    >
  </div>

<div class="panel">

  <h1>{{ show.title }}</h1>

  <section class="panel">
    <h2>Community Rating</h2>
  
    {% if avg_rating %}
      <p><strong>Average:</strong> {{ avg_rating }} / 5</p>
  
      <ul>
        {% for star in range(5, 0, -1) %}
          <li>
            {{ star }}★ — {{ rating_map.get(star, 0) }} rating(s)
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No ratings yet.</p>
    {% endif %}
  </section>


  <section>
    <p><strong>Director:</strong> {{ show.director or "N/A" }}</p>
    <p><strong>Cast:</strong> {{ show.cast or "N/A" }}</p>
    <p><strong>Release Year:</strong> {{ show.release_year or "N/A" }}</p>
    <p><strong>Rating:</strong> {{ show.rating or "N/A" }}</p>
    <p><strong>Seasons:</strong> {{ show.seasons or "N/A" }}</p>
    <p><strong>Genres:</strong> {{ show.genres or "N/A" }}</p>
    <p><strong>Description:</strong></p>
    <p>{{ show.description or "No description available." }}</p>
  </section>
</div>
</div>

  <hr>

  <section class = "panel">
    <h2>Episodes</h2>

    {% if episodes %}
      <ul
        id="episodeList"
        data-show-id="{{ show.id }}"
        data-max-watched="{{ maxWatchedEpisode or 0 }}"
      >
        {% for ep in episodes %}
          <li
            class="episode-item"
            data-episode-id="{{ ep.id }}"
            data-episode-number="{{ ep.episode_number }}"
          >
            Episode {{ ep.episode_number }}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No episodes available.</p>
    {% endif %}
  </section>

  <hr>
  <section>
        <h2>Write a Review</h2>

  {% if current_user.is_authenticated %}
  

    <form method="POST" action="{{ url_for('add_review', show_id=show.id) }}">
        <label for="episode_numbers"><strong>Select episode(s) (optional)</strong></label><br>
        <select id="episode_numbers" name="episode_numbers" multiple size="6">
            {% for ep in episodes %}
            <option value="{{ ep.episode_number }}">Episode {{ ep.episode_number }}</option>
            {% endfor %}
        </select>
        <p style="font-size: 0.9em; margin-top: 6px;">
        Hold <strong>Cmd</strong> (Mac) or <strong>Ctrl</strong> (Windows) to select multiple.
        </p>


      <br><br>

      <label for="rating"><strong>Rating (1–5)</strong></label><br>
      <input id="rating" name="rating" type="number" min="1" max="5" required>

      <br><br>

      <label for="review_text"><strong>Review</strong></label><br>
      <textarea id="review_text" name="review_text" rows="4" cols="60" required></textarea>

      <br><br>

      <button type="submit">Submit Review</button>
    </form>
  {% else %}
    <p><a href="{{ url_for('auth.login') }}">Sign in</a> to write a review.</p>
  {% endif %}

  </section>

  <hr>

  <section>
    <h2>Reviews</h2>

    <button id="toggleReviewForm">
      {% if userReview %}
        Edit Review
      {% else %}
        Add a Review
      {% endif %}
    </button>

    <div
      id="reviewForm"
      style="display:none; margin-top: 1rem;"
      data-has-review="{{ 'true' if userReview else 'false' }}"
      data-review-id="{{ userReview.id if userReview else '' }}"
    >
      <label for="reviewRating">Rating:</label>
      <select id="reviewRating">
        {% for i in range(1, 6) %}
          <option
            value="{{ i }}"
            {% if userReview and userReview.rating == i %}selected{% endif %}
          >
            {{ i }}
          </option>
        {% endfor %}
      </select>

      <br><br>

      <label for="reviewText">Review:</label><br>
      <textarea id="reviewText" rows="4" cols="50">{{ userReview.review_text if userReview }}</textarea>

      <br><br>

      <button id="submitReview">
        {% if userReview %}
          Update Review
        {% else %}
          Submit Review
        {% endif %}
      </button>
    </div>

    <hr>

    {% if reviews %}
      {% for review, username, rating, text in reviews %}
        <div class="review">
          <p><strong>{{ username }}</strong> rated <strong>{{ rating }}/5</strong></p>
          <p>{{ text }}</p>
        </div>
        <hr>
      {% endfor %}
    {% else %}
      <p>No reviews yet.</p>
    {% endif %}
  </section>

  <section>
      <form method="POST" action="{{ url_for('set_status', show_id=show.id) }}">
        <label><strong>Status</strong></label>
        <select name="status">
          <option value="planned">Plan to Watch</option>
          <option value="watching">Watching</option>
          <option value="completed">Completed</option>
        </select>
        <button type="submit">Save</button>
      </form>
  </section>


{% endblock %}
